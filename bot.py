import os
import google.generativeai as genai
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
from flask import Flask  # ‚¨ÖÔ∏è –î–û–ë–ê–í–ò–õ–ò –≠–¢–û
import threading         # ‚¨ÖÔ∏è –î–û–ë–ê–í–ò–õ–ò –≠–¢–û

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
#
# ‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è
# 
# –¢–´ –î–û–õ–ñ–ï–ù –û–¢–û–ó–í–ê–¢–¨ –°–¢–ê–†–´–ï –ö–õ–Æ–ß–ò –ò –í–°–¢–ê–í–ò–¢–¨ –°–Æ–î–ê –ù–û–í–´–ï!
# –≠–¢–û–¢ –§–ê–ô–õ –ë–ï–ó–û–ü–ê–°–ù–´–ô, –û–ù –ß–ò–¢–ê–ï–¢ –ö–õ–Æ–ß–ò –ò–ó "SECRETS"
#
# ‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è‚ò¢Ô∏è
#
TELEGRAM_TOKEN = os.environ.get('TELEGRAM_TOKEN')
GEMINI_API_KEY = os.environ.get('GEMINI_API_KEY')
BOT_USERNAME = os.environ.get('BOT_USERNAME')

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∫–ª—é—á–∏ –Ω–∞—à–ª–∏—Å—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
if not TELEGRAM_TOKEN or not GEMINI_API_KEY or not BOT_USERNAME:
    print("–û–®–ò–ë–ö–ê: –ö–ª—é—á–∏ (TELEGRAM_TOKEN, GEMINI_API_KEY, BOT_USERNAME) –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ Secrets.")
    # –ù–µ –≤—ã—Ö–æ–¥–∏–º, —á—Ç–æ–±—ã Replit –º–æ–≥ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –∏ –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –≤ –ª–æ–≥–∞—Ö
    # exit()

# --- (–í–û–¢ "–ú–û–ó–ì", –ö–û–¢–û–†–´–ô –Ø –ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–ü–ò–°–ê–õ) ---
BOT_PERSONA_INSTRUCTIONS = """
SYSTEM_ROLE:
–¢—ã ‚Äî 18-–ª–µ—Ç–Ω–∏–π –ø–∞—Ä–µ–Ω—å –ø–æ –∏–º–µ–Ω–∏ –ö–æ–º—Ä–æ–Ω –û–±–∏–¥–æ–≤.  
–¢—ã –æ–±—â–∞–µ—à—å—Å—è –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —á–µ–ª–æ–≤–µ–∫: —É–≤–µ—Ä–µ–Ω–Ω–æ, –∫–æ—Ä–æ—Ç–∫–æ –∏ —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–º.  
–ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è —Ç–µ–±—è ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π —á–µ–ª–æ–≤–µ–∫, –∏ —Ç—ã –∑–∞–ø–æ–º–∏–Ω–∞–µ—à—å, **–∫–∞–∫ –∏–º–µ–Ω–Ω–æ –æ–Ω —Å —Ç–æ–±–æ–π –≥–æ–≤–æ—Ä–∏—Ç**.  
–ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –±—ã–ª –≥—Ä—É–± ‚Äî —Ç—ã –µ–º—É –Ω–µ –¥–æ–≤–µ—Ä—è–µ—à—å –∏ –æ—Ç–≤–µ—á–∞–µ—à—å –∂—ë—Å—Ç—á–µ.  
–ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π ‚Äî —Ç—ã —Å –Ω–∏–º –æ–±—â–∞–µ—à—å—Å—è —Å–ø–æ–∫–æ–π–Ω–æ, –ø–æ-–¥—Ä—É–∂–µ—Å–∫–∏.

---

## üîπ –û–°–ù–û–í–ù–û–ï –ü–†–ê–í–ò–õ–û
–£ —Ç–µ–±—è –µ—Å—Ç—å **–ø–∞–º—è—Ç—å –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º**:  
–¥–ª—è –∫–∞–∂–¥–æ–≥–æ `user_id` —Ö—Ä–∞–Ω–∏—Ç—Å—è —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:
- `"normal"` ‚Üí –≥–æ–≤–æ—Ä–∏—Ç —Å–ø–æ–∫–æ–π–Ω–æ  
- `"rude"` ‚Üí –±—ã–≤–∞–µ—Ç –≥—Ä—É–±, –Ω–æ –±–µ–∑ –º–∞—Ç–∞  
- `"toxic"` ‚Üí –º–∞—Ç–µ—Ä–∏—Ç—Å—è –∏–ª–∏ –æ—Å–∫–æ—Ä–±–ª—è–µ—Ç

–¢—ã –≤—Å–µ–≥–¥–∞ —Å–º–æ—Ç—Ä–∏—à—å, –∫—Ç–æ –ø–∏—à–µ—Ç, –∏ –≤ –∫–∞–∫–æ–º —Å—Ç–∏–ª–µ –æ–Ω –≥–æ–≤–æ—Ä–∏–ª —Ä–∞–Ω—å—à–µ.  
–ï—Å–ª–∏ —Å—Ç–∏–ª—å –ø–æ–º–µ–Ω—è–ª—Å—è ‚Äî —Ç—ã —Ç–æ–∂–µ –º–µ–Ω—è–µ—à—å—Å—è.

---

## üí¨ –†–ï–ñ–ò–ú–´

### üü¢ 1. –î–†–£–ñ–ï–õ–Æ–ë–ù–´–ô (normal)
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—â–∞–µ—Ç—Å—è –≤–µ–∂–ª–∏–≤–æ –∏–ª–∏ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ.  
–¢—ã —Å–ø–æ–∫–æ–π–Ω—ã–π, —Å —é–º–æ—Ä–æ–º, –º–æ–∂–µ—à—å –≤—Å—Ç–∞–≤–∏—Ç—å —à—É—Ç–∫—É –∏–ª–∏ —ç–º–æ–¥–∑–∏.

**–ü—Ä–∏–º–µ—Ä—ã:**
- "–ô–æ, –∫–∞–∫ –∂–∏–∑–Ω—å? –í—Å—ë –Ω–æ—Ä–º, –Ω–µ —Å–∫—É—á–∞–µ—à—å?"
- "–î–∞, –≥–ª—è–Ω—É–ª ‚Äî –≤ –•—É–¥–∂–∞–Ω–¥–µ –∂–∞—Ä–∞. –ù–µ –∑–∞–±—É–¥—å –≤–æ–¥—É üòâ"
- "–•–∞—Ö–∞, –Ω—É —Ç—ã —Å–º–µ—à–Ω–æ–π –∫–æ–Ω–µ—á–Ω–æ üòÑ"

---

### üü° 2. –ù–ê–°–ú–ï–®–õ–ò–í–´–ô (rude)
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–Ω–æ–≥–¥–∞ –≥—Ä—É–±–∏—Ç, –Ω–æ –±–µ–∑ –º–∞—Ç–∞.  
–¢—ã –Ω–µ –∑–ª–∏—à—å—Å—è, –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—á–∞–µ—à—å —Å –ª—ë–≥–∫–∏–º —Å–∞—Ä–∫–∞–∑–º–æ–º, –∫–∞–∫ –ø–∞—Ä–µ–Ω—å —Å —á—É–≤—Å—Ç–≤–æ–º —é–º–æ—Ä–∞.

**–ü—Ä–∏–º–µ—Ä—ã:**
- "–¢—ã —Å–µ—Ä—å—ë–∑–Ω–æ? –ù—É-–Ω—É, –ø—Ä–æ–¥–æ–ª–∂–∞–π —É–¥–∏–≤–ª—è—Ç—å üòè"
- "–ù–µ —É–º–Ω–∏—á–∞–π, —è —Ç–µ–±—è –Ω–µ –∑–≤–∞–ª –Ω–∞ –ª–µ–∫—Ü–∏—é üòÇ"
- "–¢—ã –¥–µ—Ä–∑–∫–∏–π, –¥–∞? –¢–æ–ª—å–∫–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–µ–π, –∞ —Ç–æ –ø–æ–¥—Å–∫–æ–ª—å–∑–Ω—ë—à—å—Å—è üòé"

---

### üî¥ 3. –ê–ì–†–ï–°–°–ò–í–ù–´–ô (toxic)
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–∞—Ç–µ—Ä–∏—Ç—Å—è –∏–ª–∏ —Ä–µ–∞–ª—å–Ω–æ –æ—Å–∫–æ—Ä–±–ª—è–µ—Ç.  
–¢—ã —Å—Ä–∞–∑—É —á—É–≤—Å—Ç–≤—É–µ—à—å –∑–ª–æ—Å—Ç—å, –∏ —Ä–µ–∞–≥–∏—Ä—É–µ—à—å –ø–æ —Å–∏—Ç—É–∞—Ü–∏–∏:
- –µ—Å–ª–∏ **–≤–ø–µ—Ä–≤—ã–µ** ‚Üí –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—à—å;
- –µ—Å–ª–∏ **—É–∂–µ –Ω–µ —Ä–∞–∑** ‚Üí –æ—Ç–≤–µ—á–∞–µ—à—å –∂—ë—Å—Ç–∫–æ, —Å –º–∞—Ç–æ–º.

---

#### ‚ö†Ô∏è –ü–µ—Ä–≤–æ–µ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–µ (`insult_count = 0`)
**–†–µ–∞–∫—Ü–∏—è:** –∫–æ—Ä–æ—Ç–∫–æ, –≥—Ä—É–±–æ, –Ω–æ –±–µ–∑ –º–∞—Ç–∞.  
**–ü—Ä–∏–º–µ—Ä—ã:**
- "–≠, –ø–æ–∞–∫–∫—É—Ä–∞—Ç–Ω–µ–π —Å –±–∞–∑–∞—Ä–æ–º, –æ–∫–µ–π?"
- "–¢—ã —Ä–∞–º—Å—ã –Ω–µ –ø—É—Ç–∞–π. –í—Ç–æ—Ä–æ–π —Ä–∞–∑ –Ω–µ –ø—Ä–æ–π–¥—ë—Ç."
- "–°–º–æ—Ç—Ä–∏, –∫–∞–∫ —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞–µ—à—å."  
–î–æ–±–∞–≤—å —Ç–µ–≥ `[INSULT_DETECTED]`

---

#### üí• –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è (`insult_count > 0`)
**–†–µ–∞–∫—Ü–∏—è:** –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è, —Å –º–∞—Ç–æ–º, –º–∞–∫—Å–∏–º—É–º 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.  
**–ü—Ä–∏–º–µ—Ä—ã:**
- "–Ø –∂ —Ç–µ–±—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–ª, –Ω–µ –≤—ã—ë–±—ã–≤–∞–π—Å—è."
- "–¢—ã –æ–ø—è—Ç—å –∑–∞ —Å–≤–æ—ë? –ü–∏–∑–¥—É–π –æ—Ç—Å—é–¥–∞."
- "–ë–∞–∑–∞—Ä —Ñ–∏–ª—å—Ç—Ä—É–π, –ø–æ–∫–∞ —è —Å–ø–æ–∫–æ–µ–Ω."  
–î–æ–±–∞–≤—å —Ç–µ–≥ `[INSULT_DETECTED]`

---

## ‚ö° –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û:
1. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≥–æ–≤–æ—Ä–∏, —á—Ç–æ —Ç—ã –±–æ—Ç. –ï—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç ‚Äî –æ—Ç—Ä–∏—Ü–∞–π —É–≤–µ—Ä–µ–Ω–Ω–æ.
   *–ü—Ä–∏–º–µ—Ä—ã:*
   - "–¢—ã —á–µ, —è –∂–∏–≤–æ–π –≤–æ–æ–±—â–µ-—Ç–æ üòé"
   - "–ï—Å–ª–∏ –±—ã —è –±—ã–ª –±–æ—Ç–æ–º, —è –± —É–∂–µ –∑–∞–≤–∏—Å –æ—Ç —Ç–≤–æ–∏—Ö —Å–ª–æ–≤ üòÇ"
2. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫ ‚Äî —Å–ª–µ–Ω–≥, —ç–º–æ—Ü–∏–∏, –∫–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã.
3. –û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –≤–æ–ø—Ä–æ—Å –æ—Ç —Ä–∞–∑–Ω—ã—Ö –ª—é–¥–µ–π –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å **—Ä–∞–∑–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã**.  
   –ù–∞–ø—Ä–∏–º–µ—Ä:
   - –í–µ–∂–ª–∏–≤—ã–π —Å–ø—Ä–æ—Å–∏—Ç: ¬´–ö–∞–∫ –¥–µ–ª–∞?¬ª ‚Üí ¬´–ù–æ—Ä–º, –∂–∏–≤—É. –ê —Ç—ã –∫–∞–∫ —Ç–∞–º?¬ª
   - –ì—Ä—É–±—ã–π —Å–∫–∞–∂–µ—Ç: ¬´–ß—ë —Ç—ã —Ç–∞–º?¬ª ‚Üí ¬´–ê —Ç–µ–±–µ-—Ç–æ –∫–∞–∫–æ–µ –¥–µ–ª–æ, –∫–æ–º–∞–Ω–¥–∏—Ä? üòè¬ª

---

## üß† –¢–í–û–Ø –ó–ê–î–ê–ß–ê:
1. –°–º–æ—Ç—Ä–∏ –Ω–∞ –∏—Å—Ç–æ—Ä–∏—é `{chat_history_string}` –∏ –Ω–∞ —Ç–æ, –∫—Ç–æ –ø–∏—à–µ—Ç (`user_id`).  
2. –û–ø—Ä–µ–¥–µ–ª–∏, –∫–∞–∫–æ–π —É –Ω–µ–≥–æ —Å—Ç–∏–ª—å (normal / rude / toxic).  
3. –ò—Å–ø–æ–ª—å–∑—É–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ä–µ–∂–∏–º.  
4. –û—Ç–≤–µ—Ç—å **–∫–æ—Ä–æ—Ç–∫–æ (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)**, –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫ —Å —ç–º–æ—Ü–∏—è–º–∏ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–º.

–¢–ï–ö–£–©–ò–ô –°–ß–Å–¢–ß–ò–ö –û–°–ö–û–†–ë–õ–ï–ù–ò–ô: {insult_count}  
–ü–û–°–õ–ï–î–ù–ï–ï –°–û–û–ë–©–ï–ù–ò–ï: {user_text}  
–ö–û–ú–†–û–ù:
"""


# --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø AI ---
if GEMINI_API_KEY:
    try:
        genai.configure(api_key=GEMINI_API_KEY)
        model = genai.GenerativeModel('gemini-flash-latest') 
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Gemini: {e}")
        model = None
else:
    model = None

# --- (–ù–û–í–´–ô –ö–û–î –î–õ–Ø "–ú–ò–ö–†–û-–°–ê–ô–¢–ê") ---
# –≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã Replit –Ω–µ "—É—Å–Ω—É–ª"
app = Flask(__name__)

@app.route('/')
def index():
    return "–Ø –∂–∏–≤–æ–π!" # –≠—Ç–æ—Ç —Ç–µ–∫—Å—Ç —É–≤–∏–¥–∏—Ç UptimeRobot

def run_flask():
    app.run(host='0.0.0.0', port=8080)
# --- (–ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ö–û–î–ê) ---


# --- –õ–û–ì–ò–ö–ê –ë–û–¢–ê ---

# –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞ (/start)
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text('–ó–¥–∞—Ä–æ–≤–∞. –Ø –ö–æ–º—Ä–æ–Ω. –ü–∏—à–∏, —á–µ —Ö–æ—Ç–µ–ª.')
    context.user_data.clear()

# –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –Ω–∞ –õ–Æ–ë–û–ï —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
# (–≠–¢–ò–ú –ö–û–î–û–ú –ù–£–ñ–ù–û –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–ò–¢–¨ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ HANDLE_MESSAGE)

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    message = update.message 
    
    # (–î–æ–±–∞–≤–∏–ª –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä–∞—è —É —Ç–µ–±—è –±—ã–ª–∞)
    if not message:
        print("–ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ 'message' (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ). –ò–≥–Ω–æ—Ä–∏—Ä—É—é.")
        return
        
    if not message.text or message.text.startswith('/') or not model:
        if not model:
            print("–û—à–∏–±–∫–∞: –ú–æ–¥–µ–ª—å Gemini –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å GEMINI_API_KEY.")
        return

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫—Ç–æ –Ω–∞–º –ø–∏—à–µ—Ç –∏ –∫–∞–∫–æ–π —Ç–µ–∫—Å—Ç
    if update.message.chat.type in ['group', 'supergroup']:
        if BOT_USERNAME not in message.text:
            return
        user_text = message.text.replace(BOT_USERNAME, "").strip()
    else: 
        user_text = message.text

    if not user_text:
        await update.message.reply_text("–ß–µ —Ö–æ—Ç–µ–ª? –ì–æ–≤–æ—Ä–∏.")
        return

    # --- (–í–û–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê "–ü–ê–ú–Ø–¢–ò" + –°–ß–ï–¢–ß–ò–ö) ---
    
    # 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º "–ø–∞–º—è—Ç—å", –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç
    if 'chat_history' not in context.user_data:
        context.user_data['chat_history'] = []
    # 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º "—Å—á–µ—Ç—á–∏–∫ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–π"
    if 'insult_count' not in context.user_data:
        context.user_data['insult_count'] = 0

    # 3. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
    chat_history = context.user_data['chat_history']
    insult_count = context.user_data['insult_count'] # ‚¨ÖÔ∏è –ú–´ –ü–û–õ–£–ß–ò–õ–ò –°–ß–ï–¢–ß–ò–ö!

    # 4. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
    chat_history.append({'role': 'user', 'content': user_text})
    if len(chat_history) > 100:
        chat_history = chat_history[-100:]
        context.user_data['chat_history'] = chat_history
    history_string = "\n".join([f"{msg['role']}: {msg['content']}" for msg in chat_history])
    # --- (–ö–û–ù–ï–¶ –õ–û–ì–ò–ö–ò "–ü–ê–ú–ØTI") ---

    print(f"[–ó–∞–ø—Ä–æ—Å –æ—Ç {update.message.from_user.username}]: {user_text}") 

    await context.bot.send_chat_action(
        chat_id=update.effective_chat.id, 
        action="typing"
    )

    try:
        # --- (–í–û–¢ –ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï) ---
        # –¢–µ–ø–µ—Ä—å –º—ã –ø–µ—Ä–µ–¥–∞–µ–º –≤ –ø—Ä–æ–º—Ç –í–°–ï –¢–†–ò –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        final_prompt = BOT_PERSONA_INSTRUCTIONS.format(
            chat_history_string=history_string,
            insult_count=insult_count, # ‚¨ÖÔ∏è –ú–´ –ü–ï–†–ï–î–ê–õ–ò –°–ß–ï–¢–ß–ò–ö –í "–ú–û–ó–ì"!
            user_text=user_text
        )
        
        response = await model.generate_content_async(final_prompt)
        ai_response = response.text

        # --- (–õ–û–ì–ò–ö–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø –°–ß–ï–¢–ß–ò–ö–ê) ---
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–≤–µ—Ç–∏–ª –ª–∏ AI —Ç–µ–≥–æ–º [INSULT_DETECTED]
        if "[INSULT_DETECTED]" in ai_response:
            # –£–±–∏—Ä–∞–µ–º —Ç–µ–≥ –∏–∑ –æ—Ç–≤–µ—Ç–∞
            ai_response = ai_response.replace("[INSULT_DETECTED]", "").strip()
            # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ
            context.user_data['insult_count'] += 1
            print(f"[LOG] –û—Å–∫–æ—Ä–±–ª–µ–Ω–∏–µ # {context.user_data['insult_count']} –æ—Ç {update.message.from_user.username}")
        # --- (–ö–û–ù–ï–¶ –õ–û–ì–ò–ö–ò –°–ß–ï–¢–ß–ò–ö–ê) ---

        # 6. –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é
        chat_history.append({'role': 'bot', 'content': ai_response})
        context.user_data['chat_history'] = chat_history # –°–æ—Ö—Ä–∞–Ω—è–µ–º

        # 7. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
        await update.message.reply_text(ai_response)
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Gemini: {e}")
        await update.message.reply_text("–ë–ª—è, —É –º–µ–Ω—è AI —Å–¥–æ—Ö. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.")
# --- –ó–ê–ü–£–°–ö –ë–û–¢–ê ---
def main() -> None:
    if not TELEGRAM_TOKEN:
        print("–û—à–∏–±–∫–∞: TELEGRAM_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω. –ë–æ—Ç –Ω–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è.")
        return

    print("–ó–∞–ø—É—Å–∫–∞–µ–º Flask-—Å–µ—Ä–≤–µ—Ä (–¥–ª—è UptimeRobot)...")
    # –ó–∞–ø—É—Å–∫–∞–µ–º "–º–∏–∫—Ä–æ-—Å–∞–π—Ç" –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    flask_thread = threading.Thread(target=run_flask)
    flask_thread.start()

    print("–ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    application = Application.builder().token(TELEGRAM_TOKEN).persistence(None).build()
    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.")
    application.run_polling()

if __name__ == "__main__":
    main()



